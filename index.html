<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>SW London Weather</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  Â  Â  background-color: #000;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div>
Â  Â  Â  Â  <div id="weather-display" class="flex flex-col items-center justify-center">
Â  Â  Â  Â  Â  Â  <p>Checking weather on your LMS route...</p>
Â  Â  Â  Â  Â  Â  <p> </p>
Â  Â  Â  Â  Â  Â  <p> </p>
Â  Â  Â  Â  Â  Â  <p> ğŸš‡Â  Â  Â  ğŸš¶ğŸ¼â€â™€ï¸â€â¡ï¸Â  Â  Â  Â ğŸ§¥Â  Â  Â  Â  â˜‚ï¸Â  Â  Â  ? </p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // Copy the following function into your Google Apps Script project's Code.gs file.
Â  Â  Â  Â  // It should be placed outside of any <script> tags.
Â  Â  Â  Â  // This is a comment block to keep the server-side code visible in the same file.
Â  Â  Â  Â  /*
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * A simple web app to fetch weather data from Open-Meteo API.
Â  Â  Â  Â  Â * This script serves as a proxy to handle the API request.
Â  Â  Â  Â  Â *
Â  Â  Â  Â  Â * @param {object} e The event object from the web app request.
Â  Â  Â  Â  Â * @return {object} The JSON response from the weather API.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  /*
Â  Â  Â  Â  function doGet(e) {
Â  Â  Â  Â  Â  // Extract latitude and longitude from the request parameters
Â  Â  Â  Â  Â  const lat = e.parameter.lat;
Â  Â  Â  Â  Â  const lon = e.parameter.lon;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Define the number of forecast hours to retrieve.Â 
Â  Â  Â  Â  Â  // IMPORTANT: This number MUST match the value in the HTML file's script.
Â  Â  Â  Â  Â  const FORECAST_HOURS = 3;

Â  Â  Â  Â  Â  // Define the base URL for the Open-Meteo API
Â  Â  Â  Â  Â  const apiUrl = "https://api.open-meteo.com/v1/forecast";
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Construct the parameters for the API call.
Â  Â  Â  Â  Â  // Now requesting hourly data and a 6-hour forecast
Â  Â  Â  Â  Â  const params = {
Â  Â  Â  Â  Â  Â  latitude: lat,
Â  Â  Â  Â  Â  Â  longitude: lon,
Â  Â  Â  Â  Â  Â  current: "temperature_2m,weather_code,is_day",
Â  Â  Â  Â  Â  Â  hourly: "precipitation_probability",
Â  Â  Â  Â  Â  Â  forecast_hours: FORECAST_HOURS,
Â  Â  Â  Â  Â  Â  timezone: "GMT",
Â  Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  // Convert the parameters object to a URL query string
Â  Â  Â  Â  Â  const queryString = Object.keys(params)
Â  Â  Â  Â  Â  Â  .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
Â  Â  Â  Â  Â  Â  .join('&');
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const fullUrl = `${apiUrl}?${queryString}`;
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  // Fetch the data from the Open-Meteo API
Â  Â  Â  Â  Â  Â  const response = UrlFetchApp.fetch(fullUrl);
Â  Â  Â  Â  Â  Â  const json = response.getContentText();
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Set the content type to JSON to send a proper response to the front-end
Â  Â  Â  Â  Â  Â  return ContentService.createTextOutput(json)
Â  Â  Â  Â  Â  Â  Â  .setMimeType(ContentService.MimeType.JSON);
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  // Log any errors for debugging and return an error message
Â  Â  Â  Â  Â  Â  Logger.log("Error fetching weather data: " + error.message);
Â  Â  Â  Â  Â  Â  return ContentService.createTextOutput(JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  error: "Failed to fetch weather data. Check logs for details.",
Â  Â  Â  Â  Â  Â  Â  message: error.message
Â  Â  Â  Â  Â  Â  })).setMimeType(ContentService.MimeType.JSON);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  */
Â  Â  Â  Â Â 
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', () => {
Â  Â  Â  Â  Â  Â  const displayElement = document.getElementById('weather-display');

Â  Â  Â  Â  Â  Â  // Define the number of forecast hours to check for rain.
Â  Â  Â  Â  Â  Â  // IMPORTANT: This number MUST match the value in your Google Apps Script.
Â  Â  Â  Â  Â  Â  const FORECAST_HOURS = 3;

Â  Â  Â  Â  Â  Â  // IMPORTANT: Replace 'YOUR_GAS_WEB_APP_URL' with the URL of your deployed Google Apps Script web app.
Â  Â  Â  Â  Â  Â  // This URL must be from the most recent "New deployment" of your script.
Â  Â  Â  Â  Â  Â  const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxHI6qHLY8cu8Ziy3s0P-QDIrrSOcM4ZH6-Oj1t2mzHDnaAuOYhDSr8LaTQPYgw3tRTAQ/exec';
Â  Â  Â  Â  Â  Â  const LAT = 51.42;
Â  Â  Â  Â  Â  Â  const LON = -0.22;

Â  Â  Â  Â  Â  Â  if (GAS_WEB_APP_URL === 'https://script.google.com/macros/s/AKfycbwMu6aH7zU61-ndrH-T4DB3so3FYVkCUB0_Rh7LVKCPgK7qV6sA3hQNM3rBAI_TTUpVOA/exec') {
Â  Â  Â  Â  Â  Â  Â  Â  displayElement.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-500">Error: Google Apps Script URL not set.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm mt-2">Please edit this file and replace 'YOUR_GAS_WEB_APP_URL' with your deployed web app URL.</p>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const apiUrl = `${GAS_WEB_APP_URL}?lat=${LAT}&lon=${LON}`;

Â  Â  Â  Â  Â  Â  // Helper function to get a weather emoji from a WMO code
Â  Â  Â  Â  Â  Â  const wmoWeatherCodeToEmoji = (code, isDay) => {
Â  Â  Â  Â  Â  Â  Â  Â  const isNight = isDay === 0;

Â  Â  Â  Â  Â  Â  Â  Â  const emojis = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  0: isNight ? "ğŸŒ™" : "â˜€ï¸",Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  1: isNight ? "â˜ï¸ğŸŒ™" : "ğŸŒ¤ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  2: isNight ? "â˜ï¸ğŸŒ™" : "â›…ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  3: "â˜ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  45: "ğŸŒ«ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  48: "ğŸŒ«ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  51: "ğŸŒ¦ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  53: "ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  55: "ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  56: "ğŸ¥¶ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  57: "ğŸ¥¶ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  61: "ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  63: "ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  65: "ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  66: "ğŸ¥¶ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  67: "ğŸ¥¶ğŸŒ§ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  71: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  73: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  75: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  77: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  80: "â›ˆï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  81: "â›ˆï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  82: "â›ˆï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  85: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  86: "ğŸŒ¨ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  95: "ğŸŒ©ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  96: "ğŸŒ©ï¸",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  99: "ğŸŒ©ï¸"
Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  return emojis[code] || "â“";
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  fetch(apiUrl)
Â  Â  Â  Â  Â  Â  Â  Â  .then(response => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(`Network response was not ok: ${response.statusText}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return response.json();
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .then(data => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data && data.current) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const temperature = data.current.temperature_2m.toFixed(0);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weatherCode = data.current.weather_code;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const description = getWeatherDescription(weatherCode);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isDay = data.current.is_day;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const weatherEmoji = wmoWeatherCodeToEmoji(weatherCode, isDay);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Find the highest precipitation probability in the next `FORECAST_HOURS`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rainProbabilities = data.hourly.precipitation_probability.slice(0, FORECAST_HOURS);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const maxRainProbability = Math.max(...rainProbabilities);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayElement.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-[10rem] lg:text-[15rem]">${weatherEmoji}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col items-center justify-center mt-[-2rem]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-xl capitalize">${description}. ${temperature}Â°C</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-md mt-2"> ${maxRainProbability}% ğŸŒ§ï¸ - chance of rain in next ${FORECAST_HOURS} hrs </p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Send the 'page-ready' signal to the parent window
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.parent.postMessage({ type: 'page-ready' }, '*');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayElement.innerHTML = '<p class="text-red-500">No current weather data found.</p>';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  .catch(error => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Fetch error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayElement.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-red-500">Failed to load weather data.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm mt-2">Please check your Google Apps Script URL and deployment status.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });

Â  Â  Â  Â  // Helper function to get weather description from WMO code
Â  Â  Â  Â  const getWeatherDescription = (code) => {
Â  Â  Â  Â  Â  const descriptions = {
Â  Â  Â  Â  Â  Â  0: "Clear sky", 1: "Mainly clear", 2: "Partly cloudy", 3: "Overcast",
Â  Â  Â  Â  Â  Â  45: "Fog", 48: "Depositing rime fog",
Â  Â  Â  Â  Â  Â  51: "Light drizzle", 53: "Moderate drizzle", 55: "Dense drizzle",
Â  Â  Â  Â  Â  Â  56: "Light freezing drizzle", 57: "Dense freezing drizzle",
Â  Â  Â  Â  Â  Â  61: "Light rain", 63: "Moderate rain", 65: "Heavy rain",
Â  Â  Â  Â  Â  Â  66: "Light freezing rain", 67: "Heavy freezing rain",
Â  Â  Â  Â  Â  Â  71: "Light snow fall", 73: "Moderate snow fall", 75: "Heavy snow fall",
Â  Â  Â  Â  Â  Â  77: "Snow grains",
Â  Â  Â  Â  Â  Â  80: "Light rain showers", 81: "Moderate rain showers", 82: "Violent rain showers",
Â  Â  Â  Â  Â  Â  85: "Light snow", 86: "Heavy snow",
Â  Â  Â  Â  Â  Â  95: "Thunderstorm", 96: "Thunderstorm with hail", 99: "Thunderstorm with heavy hail"
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  return descriptions[code] || "Unknown weather";
Â  Â  Â  Â  };
Â  Â  </script>
</body>
</html>



